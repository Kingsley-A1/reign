<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Recover Password | REIGN</title>

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#D4AF37">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Manrope:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Toastify -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <!-- Core Styles -->
    <link rel="stylesheet" href="styles.css">

    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1.5rem;
            background: var(--royal-dark);
            background-image:
                radial-gradient(circle at 30% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 70% 80%, rgba(99, 102, 241, 0.05) 0%, transparent 50%);
        }

        .auth-container {
            width: 100%;
            max-width: 440px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo-circle {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--royal-gold) 0%, #C49B2F 100%);
            border-radius: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            box-shadow: var(--shadow-gold);
        }

        .logo-circle i {
            font-size: 2.5rem;
            color: var(--royal-dark);
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .step-dot {
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .step-dot.active {
            width: 24px;
            background: var(--royal-gold);
            border-radius: 12px;
            box-shadow: 0 0 10px var(--royal-gold-20);
        }

        .step-dot.completed {
            background: var(--success);
        }

        .step-content {
            display: none;
            animation: slideUp 0.4s ease forwards;
        }

        .step-content.active {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
            margin-left: 0.25rem;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            font-size: 1.125rem;
            pointer-events: none;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 2.75rem;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            color: white;
            font-family: var(--font-sans);
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            border-color: var(--royal-gold);
            box-shadow: 0 0 0 3px var(--royal-gold-10);
            outline: none;
        }

        .security-question-box {
            background: rgba(212, 175, 55, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 0.75rem;
            padding: 1.25rem;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .security-question-box i {
            color: var(--royal-gold);
            font-size: 1.5rem;
            margin-top: 0.125rem;
        }

        .error-message {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: var(--danger);
            font-size: 0.875rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
        }

        .back-link {
            text-align: center;
            margin-top: 1rem;
        }

        .back-link a {
            color: #64748b;
            text-decoration: none;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.2s;
        }

        .back-link a:hover {
            color: var(--royal-gold);
        }

        .success-animation {
            text-align: center;
            padding: 2rem 0;
        }

        .success-circle {
            width: 80px;
            height: 80px;
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 1.5rem;
            border: 2px solid rgba(16, 185, 129, 0.2);
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes popIn {
            from {
                transform: scale(0);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="auth-container">
        <!-- Logo Header -->
        <div class="auth-header">
            <div class="logo-circle">
                <i class="ph-fill ph-crown"></i>
            </div>
            <h1 style="color: white; margin-bottom: 0.5rem;">Recover Password</h1>
            <p class="text-muted">Restore access to your royal chambers</p>
        </div>

        <div class="glass-card" style="padding: 2rem;">
            <!-- Step Indicator -->
            <div class="step-indicator" id="stepIndicator">
                <div class="step-dot active"></div>
                <div class="step-dot"></div>
                <div class="step-dot"></div>
            </div>

            <!-- Step 1: Identify -->
            <div class="step-content active" id="step1">
                <div class="text-center" style="margin-bottom: 0.5rem;">
                    <h3 style="color: white; margin-bottom: 0.5rem;">Find Account</h3>
                    <p class="text-muted text-sm">Enter the email or phone number associated with your account.</p>
                </div>

                <form id="identifyForm">
                    <div class="input-group">
                        <label class="input-label">Email or Phone</label>
                        <div class="input-wrapper">
                            <i class="ph-duotone ph-user"></i>
                            <input type="text" id="emailInput" class="form-input"
                                placeholder="king@example.com or +1234..." required autofocus>
                        </div>
                    </div>

                    <div class="error-message" id="step1Error">
                        <i class="ph-bold ph-warning-circle"></i> <span>User not found</span>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                        Continue <i class="ph-bold ph-arrow-right"></i>
                    </button>
                </form>

                <div class="back-link">
                    <a href="auth.html"><i class="ph-bold ph-arrow-left"></i> Back to Login</a>
                </div>
            </div>

            <!-- Step 2: Security Question -->
            <div class="step-content" id="step2">
                <div class="text-center" style="margin-bottom: 0.5rem;">
                    <h3 style="color: white; margin-bottom: 0.5rem;">Security Check</h3>
                    <p class="text-muted text-sm">Verify your identity by answering your security question.</p>
                </div>

                <div class="security-question-box">
                    <i class="ph-duotone ph-shield-check"></i>
                    <div>
                        <p class="text-gold"
                            style="font-size: 0.75rem; font-weight: 700; text-transform: uppercase; margin-bottom: 0.25rem;">
                            Security Question</p>
                        <p style="color: white; font-weight: 500;" id="questionText">Loading...</p>
                    </div>
                </div>

                <form id="securityForm">
                    <div class="input-group">
                        <label class="input-label">Your Answer</label>
                        <div class="input-wrapper">
                            <i class="ph-duotone ph-key"></i>
                            <input type="text" id="answerInput" class="form-input" placeholder="Type your answer here"
                                required autocomplete="off">
                        </div>
                    </div>

                    <div class="error-message" id="step2Error">
                        <i class="ph-bold ph-warning-circle"></i> <span>Incorrect answer</span>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                        Verify & Continue <i class="ph-bold ph-check"></i>
                    </button>
                </form>

                <div class="back-link">
                    <a href="#" onclick="goToStep(1); return false;"><i class="ph-bold ph-arrow-left"></i> Back</a>
                </div>
            </div>

            <!-- Step 3: Reset Password -->
            <div class="step-content" id="step3">
                <div class="text-center" style="margin-bottom: 0.5rem;">
                    <h3 style="color: white; margin-bottom: 0.5rem;">New Password</h3>
                    <p class="text-muted text-sm">Secure your account with a strong new password.</p>
                </div>

                <form id="resetForm">
                    <div class="input-group">
                        <label class="input-label">New Password</label>
                        <div class="input-wrapper">
                            <i class="ph-duotone ph-lock"></i>
                            <input type="password" id="newPassword" class="form-input" placeholder="••••••••" required
                                minlength="6">
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Confirm Password</label>
                        <div class="input-wrapper">
                            <i class="ph-duotone ph-lock-key"></i>
                            <input type="password" id="confirmPassword" class="form-input" placeholder="••••••••"
                                required minlength="6">
                        </div>
                    </div>

                    <div class="error-message" id="step3Error">
                        <i class="ph-bold ph-warning-circle"></i> <span>Passwords do not match</span>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                        Reset Password <i class="ph-bold ph-arrows-clockwise"></i>
                    </button>
                </form>

                <div class="back-link">
                    <a href="#" onclick="goToStep(2); return false;"><i class="ph-bold ph-arrow-left"></i> Back</a>
                </div>
            </div>

            <!-- Step 4: Success -->
            <div class="step-content" id="step4">
                <div class="success-animation">
                    <div class="success-circle">
                        <i class="ph-fill ph-check"></i>
                    </div>
                    <h2 style="color: white; margin-bottom: 0.5rem;">Password Updated!</h2>
                    <p class="text-muted" style="margin-bottom: 2rem;">Your royal decree has been enacted. Your new
                        password is now active.</p>

                    <a href="auth.html" class="btn btn-primary" style="width: 100%; text-decoration: none;">
                        Back to Login
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="js/config.js"></script>
    <script>
        // State
        let userEmail = '';

        // Navigation
        function goToStep(step) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));

            // Show target step
            document.getElementById(`step${step}`).classList.add('active');

            // Update Header (hide on success)
            if (step === 4) {
                document.getElementById('stepIndicator').style.display = 'none';
            } else {
                document.getElementById('stepIndicator').style.display = 'flex';
            }

            // Update Dots
            const dots = document.querySelectorAll('.step-dot');
            dots.forEach((dot, index) => {
                dot.className = 'step-dot';
                if (index + 1 === step) dot.classList.add('active');
                if (index + 1 < step) dot.classList.add('completed');
            });

            // Clear errors
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
        }

        function showError(step, message) {
            const el = document.getElementById(`step${step}Error`);
            el.querySelector('span').textContent = message;
            el.style.display = 'flex';

            // Shake effect
            const card = document.querySelector('.glass-card');
            card.animate([
                { transform: 'translateX(0)' },
                { transform: 'translateX(-5px)' },
                { transform: 'translateX(5px)' },
                { transform: 'translateX(-5px)' },
                { transform: 'translateX(5px)' },
                { transform: 'translateX(0)' }
            ], {
                duration: 400,
                easing: 'ease-in-out'
            });
        }

        // --- Step 1: Find Account ---
        document.getElementById('identifyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('emailInput').value.trim();
            const btn = e.target.querySelector('button');
            const originalContent = btn.innerHTML;

            if (!email) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="ph-duotone ph-spinner-gap"></i> Searching...';
            btn.classList.add('loading'); // If we had loading styles

            try {
                const response = await fetch(`${Config.API_URL}/auth/get-security-question`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (!response.ok) throw new Error(data.error || 'User not found');

                userEmail = email;
                document.getElementById('questionText').textContent = data.question;
                goToStep(2);

            } catch (error) {
                showError(1, error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
                btn.classList.remove('loading');
            }
        });

        // --- Step 2: Answer Question ---
        document.getElementById('securityForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const answer = document.getElementById('answerInput').value.trim();
            if (!answer) {
                showError(2, 'Please enter an answer');
                return;
            }
            // In a real app we might verify here, but for security we verify WITH the password reset
            goToStep(3);
        });

        // --- Step 3: Reset Password ---
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const answer = document.getElementById('answerInput').value.trim();
            const p1 = document.getElementById('newPassword').value;
            const p2 = document.getElementById('confirmPassword').value;
            const btn = e.target.querySelector('button');
            const originalContent = btn.innerHTML;

            if (p1 !== p2) {
                showError(3, 'Passwords do not match');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="ph-duotone ph-spinner-gap"></i> Resetting...';

            try {
                const response = await fetch(`${Config.API_URL}/auth/reset-password-security`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: userEmail,
                        answer: answer,
                        newPassword: p1
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    if (data.error && data.error.toLowerCase().includes('answer')) {
                        goToStep(2);
                        showError(2, 'Incorrect security answer');
                    } else {
                        throw new Error(data.error || 'Reset failed');
                    }
                    return;
                }

                goToStep(4);

            } catch (error) {
                showError(3, error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        });
    </script>
</body>

</html>

