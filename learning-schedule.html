<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>King Learn | Master Your Craft</title>
    <!-- SEO & Social -->
    <meta name="description"
        content="King Learn â€” A simple, focused learning tracker to build consistent study streaks, track progress and store certificates locally.">
    <meta name="theme-color" content="#0F172A">
    <meta property="og:title" content="King Learn | Master Your Craft">
    <meta property="og:description"
        content="Track your learning, log progress, and earn certificates. Lightweight and privacy-first.">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="King Learn">
    <meta property="og:image" content="https://kingsley-a1.github.io/reign/icons/og-cover.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://kingsley-a1.github.io/reign/icons/og-cover.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <!-- Tailwind CSS (CDN for quick dev; prefer compiled CSS for production) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                    },
                    colors: {
                        king: {
                            gold: '#FFD700',
                            dark: '#0F172A', // Slate 900
                            primary: '#6366f1', // Indigo 500
                            surface: '#1E293B', // Slate 800
                        }
                    }
                }
            }
        }
    </script>
    <script defer src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Icons (Phosphor) -->
    <script defer src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">

    <!-- Toastify for Notifications -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script defer>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                    },
                    colors: {
                        king: {
                            gold: '#FFD700',
                            dark: '#0F172A', // Slate 900
                            primary: '#6366f1', // Indigo 500
                            surface: '#1E293B', // Slate 800
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0F172A;
            color: #F8FAFC;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .input-field {
            background: #334155;
            border: 1px solid #475569;
            color: white;
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: #6366f1;
            outline: none;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.06);
        }

        /* Chart container constraint */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Hide scrollbar for clean UI */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

    <!-- Top Navigation -->
    <header
        class="h-16 border-b border-slate-800 flex items-center justify-between px-4 md:px-6 bg-king-dark z-20 shrink-0"
        role="banner">
        <div class="flex items-center gap-3 cursor-pointer" onclick="app.navigate('dashboard')">
            <div
                class="w-10 h-10 bg-gradient-to-br from-king-gold to-yellow-600 rounded-lg flex items-center justify-center text-king-dark font-bold text-xl shadow-lg shadow-yellow-900/20">
                <i class="ph-fill ph-crown"></i>
            </div>
            <div>
                <h1 class="font-display font-bold text-xl tracking-tight text-white">King Learn</h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest font-semibold hidden md:block">Mastery &
                    Progress</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div
                class="hidden md:flex items-center gap-2 bg-slate-800 px-3 py-1.5 rounded-full border border-slate-700">
                <i class="ph-fill ph-fire text-orange-500"></i>
                <span class="text-sm font-medium" id="streak-display">0 Day Streak</span>
            </div>
            <!-- Settings / Profile Trigger (Mock) -->
            <button
                onclick="Toastify({text: 'Profile Settings coming soon!', duration: 2000, style: {background: '#334155'}}).showToast()"
                class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white hover:bg-indigo-500 transition-colors">
                <i class="ph-bold ph-user"></i>
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 flex overflow-hidden relative">

        <!-- Sidebar (Desktop) -->
        <aside
            class="hidden md:flex w-64 flex-col border-r border-slate-800 bg-king-dark/50 backdrop-blur-sm z-10 shrink-0"
            role="navigation" aria-label="Main Navigation">
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="app.navigate('dashboard')"
                    class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all active-nav"
                    data-target="dashboard">
                    <i class="ph-duotone ph-squares-four text-xl"></i>
                    <span class="font-medium">Dashboard</span>
                </button>
                <button onclick="app.navigate('courses')"
                    class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all"
                    data-target="courses">
                    <i class="ph-duotone ph-books text-xl"></i>
                    <span class="font-medium">My Courses</span>
                </button>
                <button onclick="app.navigate('analytics')"
                    class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-all"
                    data-target="analytics">
                    <i class="ph-duotone ph-chart-line-up text-xl"></i>
                    <span class="font-medium">Analytics</span>
                </button>
            </nav>
            <div class="p-4 border-t border-slate-800">
                <button onclick="app.showModal('add-course-modal')"
                    class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-medium flex items-center justify-center gap-2 shadow-lg shadow-indigo-900/20 transition-all transform hover:scale-[1.02]">
                    <i class="ph-bold ph-plus"></i>
                    <span>New Course</span>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main
            class="flex-1 overflow-y-auto relative bg-gradient-to-br from-king-dark to-slate-900 p-4 md:p-8 pb-24 md:pb-8"
            id="main-view" role="main">
            <!-- Views will be injected here -->
        </main>

    </div>

    <!-- Mobile Bottom Nav -->
    <nav
        class="md:hidden fixed bottom-0 left-0 right-0 h-16 bg-slate-900/95 backdrop-blur-md border-t border-slate-800 flex justify-around items-center px-2 z-40 pb-safe">
        <button onclick="app.navigate('dashboard')"
            class="nav-btn-mobile flex flex-col items-center gap-1 p-2 text-indigo-400 transition-colors"
            data-target="dashboard">
            <i class="ph-duotone ph-squares-four text-2xl"></i>
            <span class="text-[10px] font-medium">Home</span>
        </button>
        <button onclick="app.showModal('add-course-modal')" class="flex flex-col items-center justify-center -mt-8">
            <div
                class="w-14 h-14 bg-indigo-600 rounded-full flex items-center justify-center text-white shadow-lg shadow-indigo-500/30 border-4 border-slate-900 transform active:scale-95 transition-transform">
                <i class="ph-bold ph-plus text-2xl"></i>
            </div>
        </button>
        <button onclick="app.navigate('analytics')"
            class="nav-btn-mobile flex flex-col items-center gap-1 p-2 text-slate-500 transition-colors"
            data-target="analytics">
            <i class="ph-duotone ph-chart-bar text-2xl"></i>
            <span class="text-[10px] font-medium">Stats</span>
        </button>
    </nav>

    <!-- MODALS -->

    <!-- Add Course Modal -->
    <div id="add-course-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
        role="dialog" aria-modal="true" aria-labelledby="add-course-title">
        <div
            class="glass-panel w-full max-w-lg rounded-2xl p-6 shadow-2xl transform scale-100 transition-all max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="add-course-title" class="text-2xl font-display font-bold text-white">Register New Course</h2>
                <button onclick="app.hideModal('add-course-modal')" class="text-slate-400 hover:text-white"><i
                        class="ph-bold ph-x text-xl"></i></button>
            </div>

            <form id="add-course-form" onsubmit="app.handleAddCourse(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Course Title</label>
                    <input type="text" name="title" required placeholder="e.g. Google Cloud ML Engineer"
                        class="input-field w-full rounded-lg px-4 py-3">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Platform/Source</label>
                        <input type="text" name="platform" placeholder="Coursera, Udemy..."
                            class="input-field w-full rounded-lg px-4 py-3">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Duration (Hours)</label>
                        <input type="number" name="duration" placeholder="e.g. 40"
                            class="input-field w-full rounded-lg px-4 py-3">
                    </div>
                </div>

                <div class="bg-indigo-900/20 border border-indigo-500/30 rounded-xl p-4">
                    <h3 class="text-indigo-400 font-semibold mb-3 flex items-center gap-2">
                        <i class="ph-fill ph-target"></i> Your Commitment
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1">Daily Goal (Mins)</label>
                            <input type="number" name="dailyGoal" value="60"
                                class="input-field w-full rounded-lg px-3 py-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1">End Date Goal</label>
                            <input type="date" name="endDate" class="input-field w-full rounded-lg px-3 py-2 text-sm">
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="block text-xs font-medium text-slate-400 mb-1">Why are you learning this?</label>
                        <textarea name="pledge" rows="2" placeholder="I commit to finish this because..."
                            class="input-field w-full rounded-lg px-3 py-2 text-sm"></textarea>
                    </div>
                </div>

                <button type="submit"
                    class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold text-lg shadow-lg mt-4">Start
                    Journey</button>
            </form>
        </div>
    </div>

    <!-- Daily Log Modal -->
    <div id="log-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
        role="dialog" aria-modal="true" aria-labelledby="log-title">
        <div class="glass-panel w-full max-w-2xl rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 id="log-title" class="text-2xl font-display font-bold text-white">Daily Learning Log</h2>
                    <p class="text-slate-400 text-sm" id="log-course-name">Course Name</p>
                </div>
                <button onclick="app.hideModal('log-modal')" class="text-slate-400 hover:text-white"><i
                        class="ph-bold ph-x text-xl"></i></button>
            </div>

            <form id="log-form" onsubmit="app.handleSaveLog(event)" class="space-y-6">
                <input type="hidden" name="courseId" id="log-course-id">

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">What did you learn today?</label>
                    <textarea name="learned" required rows="3" class="input-field w-full rounded-xl px-4 py-3"
                        placeholder="Key concepts, new syntax, architectural patterns..."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-red-400 mb-2">The Challenge</label>
                        <textarea name="challenge" rows="3"
                            class="input-field w-full rounded-xl px-4 py-3 bg-red-900/10 border-red-900/30 focus:border-red-500"
                            placeholder="What blocked you? Error messages, confusing concepts..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-emerald-400 mb-2">The Solution</label>
                        <textarea name="solution" rows="3"
                            class="input-field w-full rounded-xl px-4 py-3 bg-emerald-900/10 border-emerald-900/30 focus:border-emerald-500"
                            placeholder="How did you fix it? Resources used, logic applied..."></textarea>
                    </div>
                </div>

                <div class="flex items-center gap-4 bg-slate-800 p-4 rounded-xl">
                    <label class="text-sm font-medium text-slate-300">Time Spent:</label>
                    <div class="flex items-center gap-2">
                        <button type="button" onclick="app.adjustTime(-15)"
                            class="w-8 h-8 rounded-lg bg-slate-700 hover:bg-slate-600 text-white">-</button>
                        <input type="number" name="timeSpent" id="log-time-spent" value="60"
                            class="w-16 text-center bg-transparent text-white font-bold text-lg border-none focus:ring-0">
                        <span class="text-slate-500 text-sm">mins</span>
                        <button type="button" onclick="app.adjustTime(15)"
                            class="w-8 h-8 rounded-lg bg-slate-700 hover:bg-slate-600 text-white">+</button>
                    </div>
                    <div class="flex-1"></div>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="milestone"
                            class="w-5 h-5 rounded border-slate-600 text-indigo-600 focus:ring-indigo-500 bg-slate-700">
                        <span class="text-sm text-yellow-400 font-medium hidden md:inline">Major Milestone?</span>
                        <span class="text-sm text-yellow-400 font-medium md:hidden">Milestone?</span>
                    </label>
                </div>

                <button type="submit"
                    class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold text-lg shadow-lg">Save
                    Log Entry</button>
            </form>
        </div>
    </div>

    <!-- Certificate Modal -->
    <div id="cert-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
        role="dialog" aria-modal="true" aria-labelledby="cert-title">
        <div class="glass-panel w-full max-w-md rounded-2xl p-6 text-center">
            <div
                class="w-16 h-16 bg-yellow-500/20 text-yellow-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="ph-fill ph-medal text-3xl"></i>
            </div>
            <h2 id="cert-title" class="text-2xl font-bold text-white mb-2">Congratulations!</h2>
            <p class="text-slate-400 mb-6">Attach your certificate for <span id="cert-course-name"
                    class="text-white font-semibold"></span></p>

            <form onsubmit="app.handleCertUpload(event)">
                <input type="hidden" id="cert-course-id">
                <div
                    class="border-2 border-dashed border-slate-600 rounded-xl p-8 mb-4 hover:border-indigo-500 hover:bg-slate-800/50 transition-all cursor-pointer relative">
                    <input type="file" id="cert-file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                        required accept="image/jpeg,image/png,image/webp,application/pdf">
                    <i class="ph-duotone ph-file-arrow-up text-4xl text-slate-500 mb-2"></i>
                    <p class="text-sm text-slate-400">Click to upload image/PDF (Max 500KB)</p>
                </div>
                <p id="cert-error" class="text-red-400 text-xs mb-4 hidden"></p>
                <button type="submit" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">Save
                    Certificate</button>
            </form>
        </div>
    </div>

    <script defer>
        // --- Quotes Database ---
        const QUOTES = [
            "Learning is not a spectator sport.",
            "The expert in anything was once a beginner.",
            "Consistency is the code to success.",
            "Small progress is still progress.",
            "Don't practice until you get it right. Practice until you can't get it wrong."
        ];

        const app = {
            data: {
                courses: [],
                profile: {
                    name: 'Learner',
                    streak: 0,
                    lastLogDate: null // Stored as ISO Date String (YYYY-MM-DD)
                }
            },

            // --- CORE LIFECYCLE ---

            init() {
                this.loadData();
                this.render('dashboard');
                this.updateStreakDisplay();
                // Check if streak is broken on init
                this.checkStreakIntegrity();
            },

            loadData() {
                try {
                    const stored = localStorage.getItem('kingLearnData');
                    if (stored) {
                        this.data = JSON.parse(stored);
                        // Data migration safety check: ensure courses have logs array
                        this.data.courses.forEach(c => {
                            if (!c.logs) c.logs = [];
                        });
                    }
                } catch (e) {
                    console.error("Data load error", e);
                    this.notify("Failed to load previous data.", "error");
                }
            },

            saveData() {
                try {
                    localStorage.setItem('kingLearnData', JSON.stringify(this.data));
                    this.updateStreakDisplay();
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        this.notify("Storage full! Delete old courses or certificates.", "error");
                    } else {
                        console.error("Save error", e);
                    }
                }
            },

            // --- NAVIGATION ---

            navigate(view) {
                // Update Nav UI
                document.querySelectorAll('.nav-btn, .nav-btn-mobile').forEach(btn => {
                    const isTarget = btn.dataset.target === view;
                    btn.classList.toggle('text-white', isTarget);
                    btn.classList.toggle('bg-slate-800', isTarget && window.innerWidth >= 768); // Desktop active bg

                    // Mobile specific
                    if (window.innerWidth < 768) {
                        btn.classList.toggle('text-indigo-400', isTarget);
                        btn.classList.toggle('text-slate-500', !isTarget);
                    } else {
                        btn.classList.toggle('text-slate-400', !isTarget);
                    }
                });

                this.render(view);
            },

            // --- RENDERERS ---

            render(view) {
                const container = document.getElementById('main-view');
                container.innerHTML = '';
                container.classList.remove('fade-in');
                void container.offsetWidth; // Trigger reflow
                container.classList.add('fade-in');

                if (view === 'dashboard') this.renderDashboard(container);
                else if (view === 'courses') this.renderCourses(container);
                else if (view === 'analytics') this.renderAnalytics(container); // FIXED: Function now exists
                else if (view.startsWith('course-')) this.renderCourseDetail(container, view.split('-')[1]);
            },

            renderDashboard(container) {
                const activeCourses = this.data.courses.filter(c => c.status === 'active');
                const completed = this.data.courses.filter(c => c.status === 'completed').length;
                const totalMins = this.data.courses.reduce((acc, c) => acc + (c.logs || []).reduce((lAcc, l) => lAcc + l.timeSpent, 0), 0);
                const randomQuote = QUOTES[Math.floor(Math.random() * QUOTES.length)];

                container.innerHTML = `
                    <div class="mb-8">
                        <h2 class="text-3xl font-display font-bold text-white mb-2">Welcome back, King.</h2>
                        <p class="text-slate-400 italic">"${randomQuote}"</p>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="glass-panel p-4 rounded-xl">
                            <p class="text-slate-400 text-xs uppercase font-bold tracking-wider mb-1">Active Courses</p>
                            <p class="text-3xl font-bold text-white">${activeCourses.length}</p>
                        </div>
                        <div class="glass-panel p-4 rounded-xl">
                            <p class="text-slate-400 text-xs uppercase font-bold tracking-wider mb-1">Completed</p>
                            <p class="text-3xl font-bold text-emerald-400">${completed}</p>
                        </div>
                        <div class="glass-panel p-4 rounded-xl">
                            <p class="text-slate-400 text-xs uppercase font-bold tracking-wider mb-1">Hours Invested</p>
                            <p class="text-3xl font-bold text-indigo-400">${(totalMins / 60).toFixed(1)}</p>
                        </div>
                        <div class="glass-panel p-4 rounded-xl">
                            <p class="text-slate-400 text-xs uppercase font-bold tracking-wider mb-1">Streak</p>
                            <p class="text-3xl font-bold text-orange-400">${this.data.profile.streak} <span class="text-sm text-slate-500 font-normal">Days</span></p>
                        </div>
                    </div>

                    <!-- Active Section -->
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-white">Active Campaigns</h3>
                        <button onclick="app.navigate('courses')" class="text-sm text-indigo-400 hover:text-indigo-300">View All</button>
                    </div>

                    ${activeCourses.length === 0 ? `
                        <div class="text-center py-12 border-2 border-dashed border-slate-700 rounded-2xl bg-slate-900/50">
                            <i class="ph-duotone ph-student text-4xl text-slate-600 mb-3"></i>
                            <p class="text-slate-400 mb-4">No active conquests. Time to expand your empire.</p>
                            <button onclick="app.showModal('add-course-modal')" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-500 transition-colors">Start a Course</button>
                        </div>
                    ` : `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${activeCourses.map(course => this.createCourseCard(course)).join('')}
                        </div>
                    `}
                `;
            },

            renderAnalytics(container) {
                // Prepare Data
                const logs = this.data.courses.flatMap(c => c.logs || []);

                // Chart 1: Last 7 Days Activity
                const last7Days = [];
                const last7DaysLabels = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const dayStr = d.toLocaleDateString(); // Localized format for comparison logic might differ, but display is fine
                    // Comparison logic: match ISO string Date part
                    const isoDate = d.toISOString().split('T')[0];

                    const dayLogs = logs.filter(l => l.date.startsWith(isoDate));
                    const mins = dayLogs.reduce((sum, l) => sum + l.timeSpent, 0);

                    last7Days.push(mins);
                    last7DaysLabels.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
                }

                // Chart 2: Time by Platform
                const platformMap = {};
                this.data.courses.forEach(c => {
                    const cMins = (c.logs || []).reduce((sum, l) => sum + l.timeSpent, 0);
                    if (cMins > 0) {
                        platformMap[c.platform] = (platformMap[c.platform] || 0) + cMins;
                    }
                });

                container.innerHTML = `
                    <div class="mb-8">
                        <h2 class="text-3xl font-display font-bold text-white mb-2">Empire Analytics</h2>
                        <p class="text-slate-400">Visualizing your growth vector.</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="glass-panel p-6 rounded-2xl">
                            <h3 class="text-white font-bold mb-4">Momentum (Last 7 Days)</h3>
                            <div class="chart-container">
                                <canvas id="chart-momentum"></canvas>
                            </div>
                        </div>
                        <div class="glass-panel p-6 rounded-2xl">
                            <h3 class="text-white font-bold mb-4">Time by Platform</h3>
                             <div class="chart-container">
                                <canvas id="chart-platform"></canvas>
                            </div>
                        </div>
                    </div>
                `;

                // Render Charts
                setTimeout(() => {
                    // Bar Chart
                    new Chart(document.getElementById('chart-momentum'), {
                        type: 'bar',
                        data: {
                            labels: last7DaysLabels,
                            datasets: [{
                                label: 'Minutes',
                                data: last7Days,
                                backgroundColor: '#6366f1',
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                                x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                            }
                        }
                    });

                    // Doughnut Chart
                    new Chart(document.getElementById('chart-platform'), {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(platformMap),
                            datasets: [{
                                data: Object.values(platformMap),
                                backgroundColor: ['#FFD700', '#6366f1', '#10b981', '#f97316', '#ef4444'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'right', labels: { color: '#cbd5e1' } }
                            }
                        }
                    });
                }, 100);
            },

            createCourseCard(course) {
                const totalSpent = (course.logs || []).reduce((acc, log) => acc + log.timeSpent, 0);
                const lastLog = course.logs && course.logs.length > 0 ? course.logs[0] : null;

                return `
                    <div class="glass-panel p-5 rounded-2xl hover:border-indigo-500/50 transition-all cursor-pointer group relative overflow-hidden flex flex-col h-full" onclick="app.navigate('course-${course.id}')">
                        <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-xs font-bold text-indigo-400 bg-indigo-900/30 px-2 py-1 rounded uppercase tracking-wide">${course.platform}</span>
                            ${course.status === 'completed' ? '<i class="ph-fill ph-check-circle text-emerald-500 text-xl"></i>' : ''}
                        </div>
                        <h4 class="text-lg font-bold text-white mb-1 group-hover:text-indigo-300 transition-colors line-clamp-1">${course.title}</h4>
                        <p class="text-slate-500 text-sm mb-4 line-clamp-2 italic flex-1">"${course.pledge || 'No pledge set.'}"</p>
                        
                        <div class="space-y-3 mt-auto">
                            <div class="flex justify-between text-xs text-slate-400 border-t border-slate-700 pt-3">
                                <span>${course.logs ? course.logs.length : 0} Logs</span>
                                <span>${(totalSpent / 60).toFixed(1)}h Spent</span>
                            </div>
                            ${lastLog ? `
                                <div class="bg-slate-800/50 p-2 rounded text-xs border border-slate-700/50">
                                    <span class="text-slate-500">Last:</span> <span class="text-slate-300 line-clamp-1">${lastLog.learned}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            },

            renderCourseDetail(container, courseId) {
                const course = this.data.courses.find(c => c.id === parseInt(courseId));
                if (!course) return this.render('dashboard');

                const totalSpent = (course.logs || []).reduce((acc, log) => acc + log.timeSpent, 0);

                container.innerHTML = `
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                        <div>
                            <button onclick="app.navigate('courses')" class="text-slate-400 hover:text-white text-sm flex items-center gap-1 mb-2">
                                <i class="ph-bold ph-arrow-left"></i> Back
                            </button>
                            <h1 class="text-2xl md:text-3xl font-display font-bold text-white break-words">${course.title}</h1>
                            <p class="text-indigo-400 text-sm font-medium uppercase tracking-widest mt-1">${course.platform} â€¢ ${(totalSpent / 60).toFixed(1)} Hours Logged</p>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            ${course.status !== 'completed' ? `
                                <button onclick="app.openLogModal(${course.id})" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold shadow-lg shadow-indigo-900/20 flex items-center gap-2">
                                    <i class="ph-bold ph-pencil-simple"></i> Log
                                </button>
                                <button onclick="app.completeCourse(${course.id})" class="px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-medium border border-slate-600">
                                    <i class="ph-bold ph-check"></i> Finish
                                </button>
                            ` : `
                                <div class="px-6 py-3 bg-emerald-900/30 border border-emerald-500/30 text-emerald-400 rounded-xl font-bold flex items-center gap-2">
                                    <i class="ph-fill ph-medal"></i> Completed
                                </div>
                            `}
                            <button onclick="app.deleteCourse(${course.id})" class="px-3 py-3 bg-red-900/20 hover:bg-red-900/40 text-red-400 rounded-xl border border-red-900/30" title="Delete Course">
                                <i class="ph-bold ph-trash"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Layout Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        
                        <!-- Main: Logs -->
                        <div class="lg:col-span-2 space-y-6">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                <i class="ph-duotone ph-notebook"></i> Learning Log
                            </h3>
                            
                            ${(!course.logs || course.logs.length === 0) ? `
                                <div class="glass-panel p-8 rounded-2xl text-center border-dashed border-slate-700">
                                    <p class="text-slate-400">No logs yet. Start your streak today.</p>
                                </div>
                            ` : course.logs.map(log => `
                                <div class="glass-panel p-6 rounded-2xl relative ${log.milestone ? 'border-l-4 border-l-yellow-500' : ''}">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm font-mono text-slate-500">${new Date(log.date).toLocaleDateString()}</span>
                                            ${log.milestone ? '<span class="text-xs bg-yellow-500/20 text-yellow-500 px-2 py-0.5 rounded font-bold uppercase">Milestone</span>' : ''}
                                        </div>
                                        <span class="text-xs font-bold text-slate-600 bg-slate-900 px-2 py-1 rounded">${log.timeSpent}m</span>
                                    </div>
                                    
                                    <div class="space-y-4">
                                        <div>
                                            <h4 class="text-sm font-bold text-indigo-400 uppercase tracking-wide mb-1">Learned</h4>
                                            <p class="text-slate-200 leading-relaxed whitespace-pre-wrap">${log.learned}</p>
                                        </div>
                                        ${log.challenge ? `
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-slate-900/50 p-4 rounded-xl border border-slate-800">
                                                <div>
                                                    <h5 class="text-xs font-bold text-red-400 uppercase mb-1 flex items-center gap-1"><i class="ph-bold ph-warning"></i> Challenge</h5>
                                                    <p class="text-sm text-slate-300 whitespace-pre-wrap">${log.challenge}</p>
                                                </div>
                                                <div>
                                                    <h5 class="text-xs font-bold text-emerald-400 uppercase mb-1 flex items-center gap-1"><i class="ph-bold ph-lightbulb"></i> Solution</h5>
                                                    <p class="text-sm text-slate-300 whitespace-pre-wrap">${log.solution}</p>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Sidebar: Info & Certificate -->
                        <div class="space-y-6">
                            <!-- Commitment Card -->
                            <div class="glass-panel p-6 rounded-2xl border-t-4 border-t-indigo-500">
                                <h3 class="font-bold text-white mb-4">The Pledge</h3>
                                <p class="text-slate-400 italic text-sm mb-4">"${course.pledge}"</p>
                                <div class="flex justify-between items-center text-sm border-t border-slate-700 pt-4">
                                    <span class="text-slate-500">Daily Goal</span>
                                    <span class="text-white font-mono">${course.dailyGoal}m</span>
                                </div>
                                <div class="flex justify-between items-center text-sm mt-2">
                                    <span class="text-slate-500">Target End</span>
                                    <span class="text-white font-mono">${course.endDate || 'N/A'}</span>
                                </div>
                            </div>

                            <!-- Certificate Card -->
                            <div class="glass-panel p-6 rounded-2xl">
                                <h3 class="font-bold text-white mb-4 flex items-center gap-2">
                                    <i class="ph-fill ph-certificate"></i> Certificate
                                </h3>
                                ${course.certificate ? `
                                    <div class="bg-slate-900 p-2 rounded-xl mb-3 relative group">
                                        <img src="${course.certificate}" class="w-full rounded-lg opacity-90 hover:opacity-100 transition-opacity cursor-pointer" onclick="app.showImage('${course.certificate}')">
                                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                            <i class="ph-bold ph-magnifying-glass-plus text-white text-3xl opacity-0 group-hover:opacity-100 transition-opacity drop-shadow-lg"></i>
                                        </div>
                                    </div>
                                    <p class="text-center text-emerald-400 text-sm font-bold flex items-center justify-center gap-1">
                                        <i class="ph-bold ph-check-circle"></i> Earned
                                    </p>
                                    <button onclick="app.removeCertificate(${course.id})" class="text-xs text-red-400 hover:text-red-300 w-full mt-2">Remove Certificate</button>
                                ` : `
                                    <div class="border-2 border-dashed border-slate-700 rounded-xl p-6 text-center">
                                        <i class="ph-duotone ph-lock-key text-3xl text-slate-600 mb-2"></i>
                                        <p class="text-slate-500 text-sm">Complete the course to upload your certificate.</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            },

            renderCourses(container) {
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-3xl font-display font-bold text-white">Your Library</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${this.data.courses.map(c => this.createCourseCard(c)).join('')}
                    </div>
                    ${this.data.courses.length === 0 ? '<p class="text-slate-500 italic">No courses found.</p>' : ''}
                `;
            },

            // --- LOGIC / ACTIONS ---

            showModal(id) {
                document.getElementById(id).classList.remove('hidden');
            },

            hideModal(id) {
                document.getElementById(id).classList.add('hidden');
                // Reset errors
                const err = document.getElementById('cert-error');
                if (err) err.classList.add('hidden');
            },

            notify(msg, type = 'success') {
                Toastify({
                    text: msg,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    style: {
                        background: type === 'error' ? "#ef4444" : "#10b981",
                        borderRadius: "8px"
                    }
                }).showToast();
            },

            handleAddCourse(e) {
                e.preventDefault();
                const formData = new FormData(e.target);

                const newCourse = {
                    id: Date.now(),
                    title: formData.get('title'),
                    platform: formData.get('platform'),
                    duration: formData.get('duration'),
                    dailyGoal: parseInt(formData.get('dailyGoal')),
                    endDate: formData.get('endDate'),
                    pledge: formData.get('pledge'),
                    status: 'active',
                    progress: 0,
                    startDate: new Date().toISOString(),
                    logs: [],
                    certificate: null
                };

                this.data.courses.unshift(newCourse);
                this.saveData();
                this.hideModal('add-course-modal');
                e.target.reset();
                this.navigate('course-' + newCourse.id);
                this.notify("New campaign started!");
            },

            openLogModal(courseId) {
                const course = this.data.courses.find(c => c.id === courseId);
                document.getElementById('log-course-id').value = courseId;
                document.getElementById('log-course-name').innerText = course.title;
                this.showModal('log-modal');
            },

            adjustTime(amount) {
                const input = document.getElementById('log-time-spent');
                input.value = Math.max(0, parseInt(input.value) + amount);
            },

            handleSaveLog(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const courseId = parseInt(formData.get('courseId'));
                const course = this.data.courses.find(c => c.id === courseId);

                const newLog = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    learned: formData.get('learned'),
                    challenge: formData.get('challenge'),
                    solution: formData.get('solution'),
                    timeSpent: parseInt(formData.get('timeSpent')),
                    milestone: formData.get('milestone') === 'on'
                };

                if (!course.logs) course.logs = [];
                course.logs.unshift(newLog);

                this.updateStreak();
                this.saveData();
                this.hideModal('log-modal');
                e.target.reset();
                this.renderCourseDetail(document.getElementById('main-view'), courseId.toString());
                this.notify("Log saved. Keep going!");
            },

            updateStreak() {
                // Streak Logic (Normalized to YYYY-MM-DD)
                const now = new Date();
                const today = now.toISOString().split('T')[0];

                // If last log was yesterday, increment. If today, do nothing. Else, reset.
                if (this.data.profile.lastLogDate !== today) {
                    const yesterdayDate = new Date();
                    yesterdayDate.setDate(yesterdayDate.getDate() - 1);
                    const yesterday = yesterdayDate.toISOString().split('T')[0];

                    if (this.data.profile.lastLogDate === yesterday) {
                        this.data.profile.streak++;
                    } else {
                        // Reset if broken
                        this.data.profile.streak = 1;
                    }
                    this.data.profile.lastLogDate = today;
                }
            },

            checkStreakIntegrity() {
                // Run on init to check if streak was broken while away
                if (!this.data.profile.lastLogDate) return;

                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const yesterdayDate = new Date();
                yesterdayDate.setDate(yesterdayDate.getDate() - 1);
                const yesterday = yesterdayDate.toISOString().split('T')[0];

                // If last log was older than yesterday, and not today, streak is broken.
                if (this.data.profile.lastLogDate !== today && this.data.profile.lastLogDate !== yesterday) {
                    this.data.profile.streak = 0;
                    this.updateStreakDisplay();
                }
            },

            completeCourse(courseId) {
                if (!confirm("Mark course as completed? This is a great achievement.")) return;
                const course = this.data.courses.find(c => c.id === courseId);
                course.status = 'completed';
                course.endDateActual = new Date().toISOString();
                this.saveData();

                document.getElementById('cert-course-id').value = courseId;
                document.getElementById('cert-course-name').innerText = course.title;
                this.showModal('cert-modal');
                this.renderCourseDetail(document.getElementById('main-view'), courseId.toString());
                this.notify("Course Completed! ðŸ‘‘");
            },

            deleteCourse(courseId) {
                if (!confirm("Are you sure? This will delete all logs and data for this course forever.")) return;
                this.data.courses = this.data.courses.filter(c => c.id !== courseId);
                this.saveData();
                this.navigate('dashboard');
                this.notify("Course deleted.", "error");
            },

            handleCertUpload(e) {
                e.preventDefault();
                const courseId = parseInt(document.getElementById('cert-course-id').value);
                const fileInput = document.getElementById('cert-file');
                const file = fileInput.files[0];
                const errorMsg = document.getElementById('cert-error');

                if (file) {
                    // 1. Size Validation (500KB limit for localStorage safety)
                    if (file.size > 500 * 1024) {
                        errorMsg.innerText = "File too large! Max 500KB (LocalStorage limit). Please compress it.";
                        errorMsg.classList.remove('hidden');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        const course = this.data.courses.find(c => c.id === courseId);
                        try {
                            // Try saving to verify quota
                            course.certificate = evt.target.result;
                            this.saveData();
                            this.hideModal('cert-modal');
                            this.renderCourseDetail(document.getElementById('main-view'), courseId.toString());
                            this.notify("Certificate Uploaded!");
                        } catch (err) {
                            course.certificate = null; // Revert
                            errorMsg.innerText = "Storage full. Cannot save image.";
                            errorMsg.classList.remove('hidden');
                        }
                    };
                    reader.readAsDataURL(file);
                }
            },

            removeCertificate(courseId) {
                if (!confirm("Remove this certificate?")) return;
                const course = this.data.courses.find(c => c.id === courseId);
                course.certificate = null;
                this.saveData();
                this.renderCourseDetail(document.getElementById('main-view'), courseId.toString());
            },

            showImage(src) {
                // Simple full screen view
                const w = window.open("");
                w.document.write(`<img src="${src}" style="max-width:100%; height:auto;">`);
            },

            updateStreakDisplay() {
                document.getElementById('streak-display').innerText = `${this.data.profile.streak} Day Streak`;
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            // Accessibility: Close modals with Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    ['add-course-modal', 'log-modal', 'cert-modal'].forEach(id => document.getElementById(id).classList.add('hidden'));
                }
            });
            app.init();
        });

    </script>
</body>

</html>
