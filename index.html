<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description"
        content="Reign - The King's Journal for planning daily activities and tracking progress with an elite, royal experience.">
    <meta name="theme-color" content="#0B0F19">
    <title>Reign | The King's Journal</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Manrope:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Toastify -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- App Styles -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/components.css">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-192.png">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kingsley-a1.github.io/reign/">
    <meta property="og:title" content="Reign | The King's Journal">
    <meta property="og:description"
        content="Rule Your Day - Plan your daily activities, track learning progress, and reign over your life with royal precision.">
    <meta property="og:image" content="https://kingsley-a1.github.io/reign/icons/og-cover.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="Reign">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://kingsley-a1.github.io/reign/">
    <meta name="twitter:title" content="Reign | The King's Journal">
    <meta name="twitter:description"
        content="Rule Your Day - Plan your daily activities, track learning progress, and reign over your life with royal precision.">
    <meta name="twitter:image" content="https://kingsley-a1.github.io/reign/icons/og-cover.png">

    <!-- PWA Install Prompt Logic -->
    <script>
        // PWA Install Prompt Handler
        let deferredPrompt = null;
        let installBannerDismissed = false;

        // Check if app is already installed
        function isAppInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches ||
                window.navigator.standalone === true ||
                localStorage.getItem('pwaInstalled') === 'true';
        }

        // Show the install banner
        function showInstallBanner() {
            const banner = document.getElementById('pwa-install-banner');
            if (banner && !installBannerDismissed && !isAppInstalled()) {
                setTimeout(() => {
                    banner.classList.add('show');
                }, 2000); // Show after 2 seconds
            }
        }

        // Hide the install banner
        function hideInstallBanner() {
            const banner = document.getElementById('pwa-install-banner');
            if (banner) {
                banner.classList.remove('show');
            }
        }

        // Handle install button click
        async function installPWA() {
            if (!deferredPrompt) {
                console.log('Install prompt not available');
                return;
            }

            // Show the install prompt
            deferredPrompt.prompt();

            // Wait for user response
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`Install prompt outcome: ${outcome}`);

            if (outcome === 'accepted') {
                localStorage.setItem('pwaInstalled', 'true');
                if (typeof Toastify !== 'undefined') {
                    Toastify({
                        text: "ðŸ‘‘ Reign installed successfully!",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        style: {
                            background: "linear-gradient(135deg, #D4AF37 0%, #C5A028 100%)",
                            color: "#0B0F19",
                            fontWeight: "600"
                        }
                    }).showToast();
                }
            }

            // Clear the deferred prompt
            deferredPrompt = null;
            hideInstallBanner();
        }

        // Dismiss the install banner
        function dismissInstallBanner() {
            installBannerDismissed = true;
            hideInstallBanner();
            // Don't show again for 7 days
            localStorage.setItem('pwaInstallDismissed', Date.now().toString());
        }

        // Check if banner was recently dismissed
        function wasBannerRecentlyDismissed() {
            const dismissedTime = localStorage.getItem('pwaInstallDismissed');
            if (!dismissedTime) return false;
            const sevenDays = 7 * 24 * 60 * 60 * 1000;
            return (Date.now() - parseInt(dismissedTime)) < sevenDays;
        }

        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('Install prompt captured');

            // Show banner if not recently dismissed
            if (!wasBannerRecentlyDismissed()) {
                showInstallBanner();
            }
        });

        // Listen for app installed event
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            localStorage.setItem('pwaInstalled', 'true');
            deferredPrompt = null;
            hideInstallBanner();
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registered:', reg.scope))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>
</head>

<body>
    <!-- PWA Install Banner -->
    <div id="pwa-install-banner" class="pwa-install-banner">
        <div class="pwa-banner-content">
            <i class="ph-fill ph-crown"></i>
            <div class="pwa-banner-text">
                <strong>Install REIGN</strong>
                <span>Add to home screen for the best experience</span>
            </div>
        </div>
        <div class="pwa-banner-actions">
            <button onclick="triggerInstall()" class="pwa-install-btn">Install</button>
            <button onclick="hideInstallBanner()" class="pwa-dismiss-btn">
                <i class="ph-bold ph-x"></i>
            </button>
        </div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <button class="mobile-menu-btn" onclick="app.toggleSidebar()" title="Menu">
                <i class="ph-bold ph-list"></i>
            </button>
            <div class="header-brand" onclick="app.navigate('dashboard')">
                <i class="ph-fill ph-crown"></i>
                <div>
                    <h1>REIGN</h1>
                    <p class="tagline hidden-mobile">Rule Your Day</p>
                </div>
            </div>

            <div class="header-actions">
                <!-- Streak Badge (visible when learning streak > 0) -->
                <div id="streak-badge" class="streak-badge hidden" onclick="app.navigate('learning')"
                    title="Learning Streak">
                    <i class="ph-fill ph-fire"></i>
                    <span id="streak-count">0</span>
                </div>

                <!-- Notifications (shown when logged in) -->
                <a href="pages/notifications.html" id="notifications-btn" class="icon-btn notification-btn hidden"
                    title="Notifications">
                    <i class="ph-bold ph-bell"></i>
                    <span id="notification-badge" class="notification-dot hidden"></span>
                </a>

                <!-- User Profile (shown when logged in) -->
                <div id="user-profile" class="user-profile hidden">
                    <a href="pages/settings.html" class="user-avatar" title="Settings">
                        <span id="user-initials">KD</span>
                        <img id="user-avatar-img" src="" alt="" style="display: none;">
                    </a>
                    <span id="sync-status" class="sync-status" title="Sync Status"></span>
                </div>

                <!-- Guest Prompt (shown when not logged in) -->
                <a href="auth.html" id="guest-prompt" class="guest-prompt hidden-mobile">
                    <i class="ph-bold ph-cloud-arrow-up"></i>
                    <span>Log In/ Sign Up</span>
                </a>

                <div class="header-time hidden-mobile">
                    <p class="date" id="current-date">Today</p>
                    <p class="time" id="current-time">00:00</p>
                </div>

                <div class="header-buttons">
                    <button onclick="app.exportData()" class="icon-btn" title="Export Backup">
                        <i class="ph-bold ph-download-simple"></i>
                    </button>
                    <label class="icon-btn" title="Import Backup" style="cursor: pointer;">
                        <i class="ph-bold ph-upload-simple"></i>
                        <input type="file" accept=".json" style="display: none;" onchange="app.importData(this)">
                    </label>
                    <button onclick="app.resetData()" class="icon-btn danger" title="Reset All Data">
                        <i class="ph-bold ph-trash"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar Overlay (Mobile) -->
            <div class="sidebar-overlay" onclick="app.toggleSidebar()"></div>

            <!-- Sidebar (Desktop) -->
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    <a href="index.html" class="nav-btn active" data-target="dashboard">
                        <i class="ph-duotone ph-throne"></i>
                        <span>The Throne</span>
                    </a>
                    <a href="pages/morning.html" class="nav-btn" data-target="morning">
                        <i class="ph-duotone ph-sun-horizon"></i>
                        <span>Morning Protocol</span>
                    </a>
                    <a href="pages/evening.html" class="nav-btn" data-target="evening">
                        <i class="ph-duotone ph-moon-stars"></i>
                        <span>Evening Report</span>
                    </a>

                    <!-- Growth & Learning Section -->
                    <div class="nav-divider"></div>
                    <p class="nav-section-label">Growth</p>

                    <a href="pages/learning.html" class="nav-btn" data-target="learning">
                        <i class="ph-duotone ph-graduation-cap"></i>
                        <span>Learning Forge</span>
                    </a>
                    <a href="pages/idea.html" class="nav-btn" data-target="idea">
                        <i class="ph-duotone ph-lightbulb"></i>
                        <span>Today's Idea</span>
                    </a>
                    <a href="pages/lessons.html" class="nav-btn" data-target="lessons">
                        <i class="ph-duotone ph-book-open-text"></i>
                        <span>Daily Lessons</span>
                    </a>

                    <!-- Reflection Section -->
                    <div class="nav-divider"></div>
                    <p class="nav-section-label">Reflection</p>

                    <a href="pages/dailygood.html" class="nav-btn" data-target="dailygood">
                        <i class="ph-duotone ph-heart"></i>
                        <span>The Good in Today</span>
                    </a>
                    <a href="pages/archive.html" class="nav-btn" data-target="archive">
                        <i class="ph-duotone ph-book-bookmark"></i>
                        <span>Journal Archive</span>
                    </a>
                    <a href="pages/relationships.html" class="nav-btn" data-target="relationships">
                        <i class="ph-duotone ph-heart-half"></i>
                        <span>Rainy Day People</span>
                    </a>

                    <!-- Planning Section -->
                    <div class="nav-divider"></div>
                    <p class="nav-section-label">Planning</p>

                    <a href="pages/events.html" class="nav-btn" data-target="events">
                        <i class="ph-duotone ph-calendar-check"></i>
                        <span>Royal Calendar</span>
                    </a>
                    <a href="#" class="nav-btn disabled" data-target="savings">
                        <i class="ph-duotone ph-piggy-bank"></i>
                        <span>Daily Savings</span>
                        <span class="nav-badge coming-soon">Soon</span>
                    </a>

                    <!-- System Section -->
                    <div class="nav-divider"></div>

                    <a href="pages/notifications.html" class="nav-btn" data-target="notifications">
                        <i class="ph-duotone ph-bell"></i>
                        <span>Notifications</span>
                    </a>
                    <a href="pages/settings.html" class="nav-btn" data-target="settings">
                        <i class="ph-duotone ph-gear-six"></i>
                        <span>Settings</span>
                    </a>
                </nav>
            </aside>

            <!-- Content Area -->
            <main class="main-content fade-in" id="main-view">
                <!-- Dynamic Content Rendered Here -->
            </main>
        </div>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <a href="index.html" class="mobile-nav-btn active" data-target="dashboard">
                <i class="ph-duotone ph-throne"></i>
                <span>Home</span>
            </a>
            <a href="pages/morning.html" class="mobile-nav-btn" data-target="morning">
                <i class="ph-duotone ph-sun"></i>
                <span>Dawn</span>
            </a>
            <a href="pages/evening.html" class="mobile-nav-btn" data-target="evening">
                <i class="ph-duotone ph-moon"></i>
                <span>Dusk</span>
            </a>
            <a href="pages/archive.html" class="mobile-nav-btn" data-target="archive">
                <i class="ph-duotone ph-book-open"></i>
                <span>Logs</span>
            </a>
            <a href="pages/learning.html" class="mobile-nav-btn" data-target="learning">
                <i class="ph-duotone ph-graduation-cap"></i>
                <span>Learn</span>
            </a>
        </nav>

        <!-- Modal Container -->
        <div id="modal" class="modal-overlay">
            <div class="modal-content glass-card">
                <!-- Modal content injected dynamically -->
            </div>
        </div>
    </div>

    <!-- PWA Install Banner -->
    <div id="pwa-install-banner" class="pwa-install-banner">
        <button class="pwa-install-close" onclick="dismissInstallBanner()" title="Dismiss">
            <i class="ph-bold ph-x"></i>
        </button>
        <div class="pwa-install-content">
            <div class="pwa-install-icon">
                <img src="icons/icon-192.png" alt="King Daily">
            </div>
            <div class="pwa-install-text">
                <h3 class="pwa-install-title">
                    <i class="ph-fill ph-crown crown"></i>
                    Install Reign
                </h3>
                <p class="pwa-install-desc">
                    Add to your home screen for <strong>instant access</strong> and a native app experience. Works
                    offline!
                </p>
                <div class="pwa-install-actions">
                    <button class="pwa-install-btn primary" onclick="installPWA()">
                        <i class="ph-bold ph-download-simple"></i>
                        Install
                    </button>
                    <button class="pwa-install-btn secondary" onclick="dismissInstallBanner()">
                        Not Now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Scripts -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/sync.js"></script>
    <script src="js/router.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/views.js"></script>
    <script src="js/app.js"></script>

    <!-- Auth & Sync Initialization -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize sync module
            Sync.init();

            // Update UI based on auth status
            const updateAuthUI = () => {
                const user = Auth.getUser();
                const profileEl = document.getElementById('user-profile');
                const guestEl = document.getElementById('guest-prompt');
                const initialsEl = document.getElementById('user-initials');
                const avatarImg = document.getElementById('user-avatar-img');

                if (user) {
                    profileEl.classList.remove('hidden');
                    guestEl.classList.add('hidden');
                    initialsEl.textContent = user.initials || 'U';

                    if (user.avatar) {
                        if (user.avatar.startsWith('data:')) {
                            avatarImg.src = user.avatar;
                        } else {
                            avatarImg.src = `${Config.API_URL.replace('/api', '')}/avatars/${user.avatar}`;
                        }
                        avatarImg.style.display = 'block';
                        initialsEl.style.display = 'none';
                    } else {
                        avatarImg.style.display = 'none';
                        initialsEl.style.display = 'block';
                    }
                } else {
                    profileEl.classList.add('hidden');
                    guestEl.classList.remove('hidden');
                }
            };

            updateAuthUI();
        });
    </script>

    <!-- Feedback Modal -->
    <script src="js/components/feedback-modal.js"></script>
    <script>
        // Trigger feedback modal on page visibility change (user leaving)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && FeedbackModal.shouldShowModal()) {
                // User is leaving, mark that we should show modal next time
                sessionStorage.setItem('reign_show_feedback_on_return', 'true');
            }
        });

        // Show modal when user returns (if criteria met)
        window.addEventListener('focus', () => {
            if (sessionStorage.getItem('reign_show_feedback_on_return') === 'true') {
                sessionStorage.removeItem('reign_show_feedback_on_return');
                setTimeout(() => FeedbackModal.show(), 1000);
            }
        });
    </script>
</body>

</html>